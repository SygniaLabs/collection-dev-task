##
## GitHub Codespaces / Dev Container - all services run together.
## The "workspace" service is the development container the IDE connects to.
##

services:
  workspace:
    image: mcr.microsoft.com/devcontainers/python:1-3.12
    volumes:
      - ..:/workspace:cached
    command: sleep infinity
    environment:
      - REDIS_HOST=redis
      - PG_HOST=postgres
      - PG_DB=pipeline
      - PG_USER=pipeline
      - PG_PASSWORD=pipeline
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: pipeline
      POSTGRES_USER: pipeline
      POSTGRES_PASSWORD: pipeline
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pipeline"]
      interval: 3s
      timeout: 2s
      retries: 10

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      timeout: 2s
      retries: 10

